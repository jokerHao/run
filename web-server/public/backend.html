<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>仕高利達-後台</title>
    <script src="js/lib/socket.io/socket.io.js"></script>
    <script src="js/lib/jquery-2.0.3.min.js"></script>
    <script src="js/game.js"></script>
    <style type="text/css">
    #state {
        /*        color:#FF0000;
*/
    }
    </style>
</head>
<script type="text/javascript">
Date.prototype.Format = function(fmt) { //author: meizz 
    var o = {
        "M+": this.getMonth() + 1, //月份 
        "d+": this.getDate(), //日 
        "h+": this.getHours(), //小时 
        "m+": this.getMinutes(), //分 
        "s+": this.getSeconds(), //秒 
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
        "S": this.getMilliseconds() //毫秒 
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}
function parseTimestamp(value) {
    return (new Date(value * 1000)).Format('yyyy/MM/dd hh:mm:ss');
}
var update_players = function() {
    game.get_players(function(err, data) {
        $('#tab_players tbody').remove();
        var str = "";
        var num = 1;
        for (var i in data) {
            var d = data[i];
            state = d.state == 0 ? "" : d.state == 1 ? "準備" : d.state == 2 ? "上場" : "休息";
            var date = parseTimestamp(d.reg_time);
            str += "<tr>";
            str += "<td>" + num + "</td>";
            str += "<td>" + date + "</td>";
            str += "<td>" + d.name + "</td>";
            str += "<td>" + d.table_num + "</td>";
            str += "<td>" + state + "</td>";
            str += "<td>" + d.code + "</td>";
            str += "</tr>";
            num++;
        }
        players = data;
        $('#tab_players').append(str);
    });
};


var update_status = function() {
    game.get_reg_state(function(err, data) {
        $('#state').text(data.state == 1 ? "開放報名中" : "報名停止");
        $('#state').css('color', data.state == 1 ? "green" : "red");
    });
};

var reg_on = function() {
    game.reg_on(function(err, data) {
        update_status();
    });
};

var reg_off = function() {
    game.reg_off(function(err, data) {
        update_status();
    });
};

var start = function () {
    game.start(function(err, data){
        if (err) {
            alert(err);
        }
    });
}

var pick6 = function () {
    game.opening(function(err, data){
        if (err) {
            alert('人數不夠');
        }
    });
}

$(document).ready(function() {
    update_players();
    update_status();

    $(".update").click(function(){
        setTimeout(function(){
            update_players();
        }, 500);
    });
});

var test = function () {
    for (var i=0; i <12; i++) {
        game.register("name"+i, i);
    }
}

var players;
var test2 = function () {

    var ii = 0; 
    for (var i in players) {
        if (players[i].state==1 && ii<5) {
            ii++;
            game.auth(players[i].code, function(err, data){
                game.login(data.uid, function(){
                    
                });
            });
        }
    }
}

</script>

<body>
    <p>仕高利達後台</p>
    <p id="state"></p>
    <hr>
    <div>
        <button class="update" onclick="game.init()">清空報名</button>
        <button onclick="reg_on()">開放報名</button>
        <button onclick="reg_off()">停止報名</button>
        <button class="update" onclick="pick6();">抽選6人</button>
        <button onclick="start()">開始遊戲</button>
        <button class="update" onclick="test()">12人報名</button>
        <button class="update" onclick="test2()">5人上場</button>        
    </div>
    <hr>
    <div>
        參賽玩家:
        <table border="1" id="tab_players">
            <thead>
                <tr>
                    <th>編號</th>
                    <th>報名時間</th>
                    <th>暱稱</th>
                    <th>桌號</th>
                    <th>狀態</th>
                    <th>序號</th>
                </tr>
            </thead>
        </table>
    </div>
</body>

</html>
