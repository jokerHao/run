<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>坦克大戰 - 後台</title>

    <script src="js/lib/jquery-2.0.3.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>


    <script src="js/lib/socket.io/socket.io.js"></script>
    <script src="js/game.js"></script>
    <style type="text/css">
    img {
        width: 100px;
        height: 100px;
        display: block;
    }
    </style>
</head>
<script type="text/javascript">
Date.prototype.Format = function(fmt) { //author: meizz 
    var o = {
        "M+": this.getMonth() + 1, //月份 
        "d+": this.getDate(), //日 
        "h+": this.getHours(), //小时 
        "m+": this.getMinutes(), //分 
        "s+": this.getSeconds(), //秒 
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
        "S": this.getMilliseconds() //毫秒 
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}
function parseTimestamp(value) {
    return (new Date(value * 1000)).Format('hh:mm:ss');
}
var pstate = ["","準備","上場","休息"];
var pstate_cls = ["", "bg-warning", "bg-success", "active"]
var update_players = function() {
    game.get_players(function(err, data) {
        $('#tab_players tbody').remove();
        var str = "";
        var num = 1;
        for (var i in data) {
            var d = data[i];
            var date = parseTimestamp(d.reg_time);
            str += "<tr class=\""+pstate_cls[d.state]+"\">";
           
            str += "<td>" + num + "</td>";
            str += "<td>" + date + "</td>";            
            if (d.avatar)
                str += "<td><img class=\"img-rounded\" src=" + d.avatar + " /></td>";
            else
                str += "<td></td>";             
            str += "<td>" + d.name + "</td>";
            str += "<td>" + d.table_num + "</td>";
            str += "<td>" + d.code + "</td>";
            str += "<td>" + (d.share ? 'O':'X') + "</td>";                        
            str += "<td>" + pstate[d.state] + "</td>";            
            str += "<td>" + (d.gid ? (parseInt(d.gid)+1):"") + "</td>";
            str += "<td>" + (d.rank ? (parseInt(d.rank)+1):"") + "</td>";            
            str += "</tr>";
            num++;
        }
        players = data;
        $('#tab_players').append(str);
    });
};

var players;
var update_status = function() {
    game.get_state(function(err, data) {
        var STATE = {
            "REGISTER": 0,      // 報名
            "PAUSE":    1,      // 停止報名
            "WAIT":     2,      // 已抽出選手 等待登入
            "READY":    3,      // 客戶端表演結束 且選手皆已登入
            "PLAY":     4       //
        };

        var state_name = ["開放報名", "停止報名", "等待倒數", "等待玩家登入 - 後台啟動遊戲", "遊戲中"];
        var state_color = ['green', 'red', 'black', 'blace', 'blue'];
        $('#state').text(state_name[data.state]);
        $('#state').css('color', state_color[data.state]);
    });
};

var reg_on = function() {
    game.reg_on(function(err, data) {
        update_status();
    });
};

var reg_off = function() {
    game.reg_off(function(err, data) {
        update_status();
    });
};

var start = function () {
    game.start(function(err, data){
        if (err) {
            alert(err, data);
        }
    });
}

var pick6 = function () {
    game.opening(function(err, data){
        if (err) {
            if (err==200) {
                alert('人數不夠');
            }
            else {
                alert('遊戲尚未連接');
            }
        }
    });
}

$(document).ready(function() {
    update_players();
    update_status();

    $(".update").click(function(){
        update_status();
        setTimeout(function(){
            update_players();
        }, 500);
    });
});


// ----
var test_register_id = 0;
var test_register = function (count) {
    for (var i=0; i <count; i++) {
        game.register("坦克"+test_register_id+i, i);
    }
}

var test_login = function (count) {
    var ii = 0; 
    for (var i in players) {
        if (players[i].state==1 && ii<count) {
            ii++;
            game.auth(players[i].code, function(err, data){
                game.login(data.uid, function(){
                    update_players();
                });
            });
        }
    }
}

</script>

<body class="container">
    <div><center>
        <h1>坦克大戰後台</h1>
        <h4>
        狀態 : [ <b><state id="state"></state></b> ]
        </h4>
    </center></div>
    <center><div class="col-md-12">
        <button class=" btn btn-default update" onclick="update_status()">更新狀態</button>
        <button class=" btn btn-warning update" onclick="game.init()">初始化</button>
        <button class=" btn btn-default update" onclick="reg_on()">開放報名</button>
        <button class=" btn btn-default update" onclick="reg_off()">停止報名</button>
        <button class=" btn btn-primary update" onclick="pick6()">抽選6人</button>
        <button class=" btn btn-success update" onclick="start()">開始遊戲</button>
        <button class=" btn btn-danger update" onclick="game.restart()">重啟遊戲</button>

        <button class="btn btn-default update" onclick="test_register(12)">12人報名</button>
        <button class="btn btn-default update" onclick="test_register(5)">5人報名</button>
        <button class="btn btn-default update" onclick="test_register(4)">4人報名</button>
    </div></center>
    <div class="col-md-12">
        <h4>玩家列表:</h4>
        <table id="tab_players" class="table table-bordered table-condensed">
            <thead>
                <tr>
                    <th>編號</th>                
                    <th>報名時間</th>                    
                    <th>頭像</th>                
                    <th>暱稱</th>
                    <th>桌號</th>
                    <th>序號</th>
                    <th>FB分享</th>
                    <th>狀態</th>                    
                    <th>場次</th>
                    <th>排名</th>
                </tr>
            </thead>
        </table>
    </div>
</body>

</html>
