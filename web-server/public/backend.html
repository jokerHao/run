<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>仕高利達 - 後台</title>
    <script src="js/lib/socket.io/socket.io.js"></script>
    <script src="js/lib/jquery-2.0.3.min.js"></script>
    <script src="js/game.js"></script>
    <style type="text/css">
    img {
        width: 150px;
        height: 150px;
        display: block;
    }
    </style>
</head>
<script type="text/javascript">
Date.prototype.Format = function(fmt) { //author: meizz 
    var o = {
        "M+": this.getMonth() + 1, //月份 
        "d+": this.getDate(), //日 
        "h+": this.getHours(), //小时 
        "m+": this.getMinutes(), //分 
        "s+": this.getSeconds(), //秒 
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
        "S": this.getMilliseconds() //毫秒 
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}
function parseTimestamp(value) {
    return (new Date(value * 1000)).Format('yyyy/MM/dd hh:mm:ss');
}
var update_players = function() {
    game.get_players(function(err, data) {
        $('#tab_players tbody').remove();
        var str = "";
        var num = 1;
        for (var i in data) {
            var d = data[i];
            state = d.state == 0 ? "" : d.state == 1 ? "準備" : d.state == 2 ? "上場" : "休息";
            var date = parseTimestamp(d.reg_time);
            str += "<tr>";
           
            str += "<td>" + num + "</td>";
            if (d.avatar)
                str += "<td><img src=" + d.avatar + " /></td>";
            else
                str += "<td></td>";             
            str += "<td>" + date + "</td>";
            str += "<td>" + d.name + "</td>";
            str += "<td>" + d.table_num + "</td>";
            str += "<td>" + d.code + "</td>";
            str += "<td>" + (d.share ? 'O':'X') + "</td>";                        
            str += "<td>" + state + "</td>";            
            str += "<td>" + (d.gid ? (parseInt(d.gid)+1):"") + "</td>";
            str += "<td>" + (d.rank ? (parseInt(d.rank)+1):"") + "</td>";            
            str += "</tr>";
            num++;
        }
        players = data;
        $('#tab_players').append(str);
    });
};

var players;
var update_status = function() {
    game.get_state(function(err, data) {
        var STATE = {
            "REGISTER": 0,      // 報名
            "PAUSE":    1,      // 停止報名
            "WAIT":     2,      // 已抽出選手 等待登入
            "READY":    3,      // 客戶端表演結束 且選手皆已登入
            "PLAY":     4       //
        };

        var state_name = ["報名中", "停止報名", "等待倒數", "等待玩家登入 - 後台啟動遊戲", "遊戲中"];
        var state_color = ['green', 'red', 'black', 'blace', 'blue'];
        $('#state').text(state_name[data.state]);
        $('#state').css('color', state_color[data.state]);
    });
};

var reg_on = function() {
    game.reg_on(function(err, data) {
        update_status();
    });
};

var reg_off = function() {
    game.reg_off(function(err, data) {
        update_status();
    });
};

var start = function () {
    game.start(function(err, data){
        if (err) {
            alert(err, data);
        }
    });
}

var pick6 = function () {
    game.opening(function(err, data){
        if (err) {
            if (err==200) {
                alert('人數不夠');
            }
            else {
                alert('遊戲尚未連接');
            }
        }
    });
}

$(document).ready(function() {
    update_players();
    update_status();

    $(".update").click(function(){
        setTimeout(function(){
            update_players();
        }, 500);
    });
});


// ----
var test_register_id = 0;
var test_register = function (count) {
    test_register_id += 100;    
    for (var i=0; i <count; i++) {
        game.register("name"+test_register_id+i, i);
    }
}

var test_login = function (count) {
    var ii = 0; 
    for (var i in players) {
        if (players[i].state==1 && ii<count) {
            ii++;
            game.auth(players[i].code, function(err, data){
                game.login(data.uid, function(){
                    update_players();
                });
            });
        }
    }
}

</script>

<body>
    <h1>仕高利達後台</h1>
    <hr>
    當前狀態 : [ <b><state id="state"></state></b> ]
    <hr>
    <div>
        <button onclick="update_status()">更新狀態</button>
        <button class="update" onclick="game.init()">初始化</button>
        <button onclick="reg_on()">開放報名</button>
        <button onclick="reg_off()">停止報名</button>
        <button class="update" onclick="pick6()">抽選6人</button>
        <button onclick="start()">開始遊戲</button>
        <button onclick="game.restart()">重啟遊戲</button>

        <button class="update" onclick="test_register(12)">12人報名</button>
        <button class="update" onclick="test_register(5)">5人報名</button>
        <button class="update" onclick="test_register(4)">4人報名</button>

<!--         <button class="" onclick="test_login(5)">5人登入</button>    
        <button class="" onclick="test_login(4)">4人登入</button>         -->
    </div>
    <hr>
    <div>
        <h4>玩家列表:</h4>
        <table border="1" id="tab_players">
            <thead>
                <tr>
                    <th>編號</th>                
                    <th>頭像</th>                
                    <th>報名時間</th>
                    <th>暱稱</th>
                    <th>桌號</th>
                    <th>序號</th>
                    <th>FB分享</th>
                    <th>狀態</th>                    
                    <th>場次</th>
                    <th>排名</th>
                </tr>
            </thead>
        </table>
    </div>
</body>

</html>
