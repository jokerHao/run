<!DOCTYPE html>
<!-- saved from url=(0055)http://examples.phaser.io/embed.php?f=games/invaders.js -->
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>仕高利達</title>
    <meta name="viewport" content="initial-scale=1 maximum-scale=1 user-scalable=0 minimal-ui">
    <script src="../js/lib/jquery-2.0.3.min.js" type="text/javascript"></script>
    <script src="../js/lib/phaser.2.4.4.min.js" type="text/javascript"></script>
    <script src="../js/lib/socket.io/socket.io.js"></script>
    <script src="../js/game.js"></script>
    <script src="./scripts/player.js"></script>    
    <script src="./scripts/state_start.js"></script>
    <style>
    body {
        margin: 0px;
        padding: 0px;
        font-family: Arial;
        font-size: 14px;
        background-color: #000000;
        color: #fff;
    }
    
    canvas {
        margin: auto;
    }
    </style>
</head>

<body>
    <div id="phaser-example"></div>
    <script type="text/javascript">
    var bg_width = 720;
    var bg_height = 1280;
    var aspect = bg_width / bg_height;

    function resizeGame() {
        var height = $(window).height();
        var width = $(window).width();
        phaser.width = height * aspect;
        phaser.height = height;
    }

    // pid: data
    var players = {};

    function getPlayerByIdx (idx) {
        var keys = Object.keys(players);
        if (keys.length>idx) {
            return players[keys[idx]];
        }
        return null;
    };

    var phaser;
    var self = this;
    var state_start;

    phaser = new Phaser.Game(bg_width, bg_height, Phaser.CANVAS, 'phaser-example', {
        'preload': preload,
        'create': create,
        'update': update,
        'render': render
    });


    self.phaser = phaser;
    state_start = new StateStart(phaser, 60,
        // 倒數改變
        function(val) {
            if (val % 10 == 0) {
                // 每10秒顯示一位玩家
                var idx = (60-val)/10 - 1;
                console.log('show ', idx);
                var p = getPlayerByIdx(idx);
                p.visible(true);
            }
            if (val == 0) {
                console.log('倒數結束');
                    // 剛倒數完 通知server client表演結束
                game.client_ready();
                state_start.second(10);
            }
        });

    function preload() {
        // 遊戲背景
        phaser.load.image('background', 'assets/background.png');
        // http://img.webmd.com/dtmcms/live/webmd/consumer_assets/site_images/articles/health_tools/dog_breed_health_issues_slideshow/getty_rm_photo_of_boxer_dog_looking_at_camera.jpg

        // phaser.load.image('background', 'http://www.sydsvenskan.se/ScaledImages/644x429/Images2/2014/3/16/boll_frii.jpg?h=c21626f0c0f3a1346d6e0e4e8ed96158&fill=False&cut=False&ql=Undefined');
        
        // 皇冠6個
        phaser.load.image('rank', 'assets/rank/background.png');
        for (var i = 0; i < 6; i++) {
            phaser.load.image('rank' + i, 'assets/rank/' + i + '.png');
        }

        // 食物10個
        for (var i = 0; i < 10; i++) {
            phaser.load.image('food' + i, 'assets/food/' + i + '.png');
        }

        // 玩家
        phaser.load.image('player', 'assets/player/background.png');
        phaser.load.image('player_default', 'assets/player/default.png');
        phaser.load.image('player_table', 'assets/player/table.png');

        phaser.load.image('player_on', 'assets/player/on.png');
        phaser.load.image('player_off', 'assets/player/off.png');

        // 盤子
        phaser.load.image('start_dish', 'assets/start_dish.png');
        state_start.preload();
    }


    var dishs = [];
    var foods = [];

    // var start_dish;

    function create() {

        // enable time.fps
        phaser.time.advancedTiming = true;

        start_dish = phaser.add.group();
        start_dish.enableBody = true;
        start_dish.createMultiple(1000, 'start_dish');

        phaser.physics.startSystem(Phaser.Physics.ARCADE);

        // 創建背景
        phaser.add.sprite(0, 0, 'background');

        for (var i = 0; i < 6; i++) {
            dishs[i] = [];
            for (var ii = 0; ii < 70; ii++) {
                var obj = phaser.add.sprite(0, 0, 'start_dish');
                obj.reset(20 + i * 115 + 20 * Math.random(), 1115 - ii * 15);
                obj.visible = false;
                dishs[i].push(obj);
            }            
        }

        // 開始摟
        game.monitor(
            // 抽出六人
            function(err, data) {
                console.log("六人抽出 倒數顯示玩家..")
                state_start.start();

                // 玩家資料初始化
                var i = 0;
                for (var pid in data) {
                    var d = data[pid];
                    var x = 18 + i * 116;
                    var y = 1065;
                    var p = new Player(phaser);
                    p.body.x = x;
                    p.body.y = y;
                    p.set(pid, d.name, d.table_num, d.avatar);
                    p.visible(false);
                    players[pid] = p;
                    i++;
                }
            },

            // 後台控制 - 比賽開始
            function(err, data) {    
                console.log("開始前倒數...");
                // 開始前倒數
                state_start.second_start(function(val){
                    if (val==0) {
                        console.log('遊戲開始');
                        state_start.end();                      
                        game.client_start();   
                        gameSTART();
                    }
                });            
            },

            // 後台控制 - 重啟
            function(err, data) {
                window.location.href = "/main/";
            },

            // 玩家登入
            function(err, data) {
                console.log("玩家登入 : ", data.pid);
                if (state == STATE.END) {
                    return;
                }
                var pid = data.pid;
                if (pid && players[pid]) {
                    players[pid].online(true);
                }
            },

            // 玩家登出
            function(err, data) {
                console.log("玩家登出 : ", data.pid);
                if (state == STATE.END) {
                    return;
                }
                var pid = data.pid;
                if (pid && players[pid]) {
                    players[pid].online(false);
                }                
            }
        );

        food();

        $(window).resize(function() {
            resizeGame();
        });
        window.resizeGame();
        state_start.create();
    }

    var STATE = {
        "IDLE" : 0,
        "PLAY" : 1,
        "END" : 2
    };
    var state = STATE.IDLE;

    function update() {
        if (state==STATE.IDLE) {
            
        }
        else if (state==STATE.PLAY) {
            for (var i in players) {
                var p = players[i];
                p.update(phaser.time.fps);
            }
        }
        else {

        }
    }

    function render() {

    }

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // 食物擺放
    function getRoule() {
        var result = [];
        result.push([950, 500, 240, 700, 300]);
        // result.push([280, 200, 700, 380, 850]);
        // result.push([350, 600, 420, 900, 180]);
        result.push([880, 380, 250, 600, 500]);
        result.push([1000, 550, 850, 720, 230]);
        result.push([930, 780, 300, 500, 680]);
        result.push([1020, 800, 400, 550, 680]);
        result.push([1040, 730, 950, 320, 610]);

        // var idx = getRandomInt(0, result.length - 1);
        return result;
    }

    // 食物擺放
    function getRoule2() {
        var result = [];
        result.push([0, 2, 4, 9, 1]);
        result.push([7, 8, 6, 5, 3]);
        result.push([1, 6, 3, 6, 0]);
        result.push([9, 7, 0, 2, 8]);
        result.push([6, 1, 2, 0, 5]);
        result.push([5, 2, 8, 3, 9]);
        var idx = getRandomInt(0, result.length - 1);
        return result[idx];
    }

    function getRoule3() {
        var result = [];
        result.push([3, 1, 2, 5, 4, 0]);
        result.push([5, 2, 4, 3, 5, 1]);
        result.push([0, 4, 5, 1, 3, 2]);
        result.push([2, 5, 4, 1, 0, 3]);
        result.push([1, 3, 5, 2, 4, 5]);
        var idx = getRandomInt(0, result.length - 1);
        return result[idx];
    }

    // 產生食物
    function food() {

        var r3 = getRoule3();
        var ary = getRoule();
        // console.log(ary);
        // console.log(r3);
        for (var i = 0; i < 6; i++) {
            foods[i] = [];
            var ary2 = getRoule2();            
            for (var ii in ary2) {
                // var idx = getRandomInt(0, 9);
                var idx = ary2[ii];
                var p = phaser.add.sprite(0, 0, 'food' + idx);

                var y = ary[r3[i]];
                p.reset(10 + i * 115, y[ii]);
                p.anchor.setTo(0, 1);
                foods[i].push(p);
            }
        }
    }

    // 遊戲開始
    function gameSTART() {
        state = STATE.PLAY;
        setInterval(function() {
            if (state!=STATE.PLAY) {
                return;
            }
            game.get_score(function(err, data) {
                for (var pid in data) {
                    players[pid].score = data[pid];
                }
            });
        }, 100);

        // 盤子追
        setInterval(function() {
            if (state!=STATE.PLAY) {
                return;
            }
            for (var i=0; i<6; i++) {
                var p = getPlayerByIdx(i);
                var y = p.body.y;
                for (var ii in dishs[i]) {
                    if (dishs[i][ii].y - 80 > y) {
                        dishs[i][ii].visible = true;
                    }
                }
            }

        }, 300);

        // 消滅食物
        setInterval(function() {
            if (state!=STATE.PLAY) {
                return;
            }
            for (var i in foods) {
                var p = getPlayerByIdx(i);
                for (ii in foods[i]) {
                    if (foods[i][ii].y > p.body.y) {
                        foods[i][ii].visible = false;
                    }
                }
            }

        }, 500);        

        // 檢測勝利
        setInterval(function() {
            if (state!=STATE.PLAY) {
                return;
            }            
            var players_y = [];            
            for (var i in players) {
                var p = players[i];
                var y  = p.body.y;
                if (y<100) {
                    state = STATE.END;
                }
                players_y.push([i, y]);
            }
            if (state==STATE.END) {
                players_y.sort(function(a, b) {
                    return a[1] - b[1];
                });
                for (var i in players_y) {
                    var pid = players_y[i][0];
                    players[pid].end(i);
                }
            }
        }, 300);
    }

    function addPlayer (p) {

    }
    </script>
</body>

</html>
