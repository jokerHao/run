<!DOCTYPE html>
<!-- saved from url=(0055)http://examples.phaser.io/embed.php?f=games/invaders.js -->
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>仕高利達 遊戲</title>
    <meta name="viewport" content="initial-scale=1 maximum-scale=1 user-scalable=0 minimal-ui">
    <script src="../js/lib/jquery-2.0.3.min.js" type="text/javascript"></script>
    <script src="../js/lib/phaser.2.4.4.min.js" type="text/javascript"></script>
    <script src="../js/lib/socket.io/socket.io.js"></script>
    <script src="../js/game.js"></script>
    <style>
    body {
        margin: 0px;
        padding: 0px;
        font-family: Arial;
        font-size: 14px;
        background-color: #000000;
        color: #fff;
    }
    
    canvas {
        margin: auto;
    }
    </style>
</head>

<body>
    <div id="phaser-example"></div>
    <script type="text/javascript">
    // $(window).resize(function() {
    //     $("body").prepend("<div>" + $(window).height() + "</div>");
    // });

    var bg_width = 720;
    var bg_height = 1280;
    var aspect = bg_width/bg_height;

    function resizeGame() {
        var height = $(window).height();
        var width = $(window).width();
        phaser.width = height*aspect;
        phaser.height = height;
    }

    $(window).resize(function() { resizeGame(); });
    $(window).ready(function() { resizeGame(); });

    var players = null;
    var players_obj = [];

    var update_players = function(err, data) {
        if (!data)
            return;
        console.log('update_players');
        players = data;
        var idx = 0;
        for (var i in players) {
            console.log(i);
            players[i].obj = players_obj[idx];
            players[i].speed = 0;
            players[i].last_spd = 0;
            idx++;
        }
    };
    var update;
    var update_score = function() {
        game.get_score(function(err, data) {
            console.log('fuck');
            console.log(players);
            for (var pid in data) {
                var now_spd = data[pid];
                var p = players[pid];
                if (!p.last_spd) {
                    p.last_spd = now_spd;
                }
                console.log(now_spd + '  ' + p.last_spd);
                p.speed += (now_spd - p.last_spd) * 100;
                p.last_spd = now_spd;
            }
        });
    };

    var slow = function() {
        for (var i in players) {
            var p = players[i];
            p.speed -= 10;
            if (p.speed <= 0) {
                p.speed = 0;
            }
        }
    }

    var start = function(err, data) {
        // update = setInterval("update_score()", 200);
        setInterval("slow()", 50);
    };

    var player_in = function(err, data) {
        $("#" + data.pid).text("上場");
    };

    console.log(window);
    // ------
    var phaser = new Phaser.Game(bg_width, bg_height, Phaser.AUTO, 'phaser-example', {
        'preload': preload,
        'create': create,
        'update': update,
        'render': render
    });


    function preload() {
        phaser.load.image('background', 'assets/player/start_background.png');
        phaser.load.image('player', 'assets/player/bg.png');

        for (var i = 0; i < 10; i++) {
            phaser.load.image('open_' + i, 'assets/open/' + i + '.png');
        }
    }

    function create() {
        //  The scrolling starfield background
        var background = phaser.add.tileSprite(0, 0, bg_width, bg_height, 'background');

        var ps = phaser.add.group();
        ps.enableBody = true;
        ps.createMultiple(6, 'player');
        for (var i = 0; i <= 6; i++) {
            var p = ps.getFirstExists(false);
            if (p) {
                p.reset(20 + i * 115, 1115);
                // p.body.velocity.y = -400;
                players_obj.push(p);
            }
        }

        game.monitor(update_players, start, player_in);
        game.get_gameing(function(err, data) {
            if (!data) {
                return;
            }
            update_players(null, data.players);
            if (data.start) {
                start();
            }
        });
        window.resizeGame();
    }

    function update() {
        // console.log('update');
        for (var i in players) {
            var p = players[i];
            p.obj.body.velocity.y = p.speed * -1;
        }
    }

    function render() {

    }
    </script>
</body>

</html>
